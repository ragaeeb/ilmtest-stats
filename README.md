# IlmTest Stats

[![wakatime](https://wakatime.com/badge/user/a0b906ce-b8e7-4463-8bce-383238df6d4b/project/1fef3599-9317-4cbf-9885-96470bf9239f.svg)](https://wakatime.com/badge/user/a0b906ce-b8e7-4463-8bce-383238df6d4b/project/1fef3599-9317-4cbf-9885-96470bf9239f)
[![codecov](https://codecov.io/gh/ragaeeb/ilmtest-stats/graph/badge.svg?token=NEUJ7VJ1UR)](https://codecov.io/gh/ragaeeb/ilmtest-stats)
[![Vercel Deploy](https://deploy-badge.vercel.app/vercel/ilmtest-stats)](https://ilmtest-stats.vercel.app)
[![typescript](https://badgen.net/badge/icon/typescript?icon=typescript&label&color=blue)](https://www.typescriptlang.org)
[![Node.js CI](https://github.com/ragaeeb/ilmtest-stats/actions/workflows/build.yml/badge.svg)](https://github.com/ragaeeb/ilmtest-stats/actions/workflows/build.yml)
![Bun](https://img.shields.io/badge/Bun-%23000000.svg?style=for-the-badge&logo=bun&logoColor=white)
![GitHub License](https://img.shields.io/github/license/ragaeeb/ilmtest-stats)

A Bun + Next.js workspace used to ingest CSV/JSON exports from the IlmTest ecosystem, normalize the data and surface interactive dashboards. The repository contains both the production web app and a set of data pipelines that compress, encrypt and aggregate analytics for:

- **Session analytics** collected from the web properties.
- **Automatic blocking reports** that highlight abusive addresses and keywords.
- **BlackBerry 10 application telemetry** for the quran10, sunnah10 and salat10 apps.
- **Collection progress tracking** for Quran memorisation and related study plans.

The goal of the project is to keep the dashboards fast and privacy-aware by precomputing artefacts (Brotli compressed JSON/CSV) that are then served directly by the Next.js routes.

## Architecture

- **Runtime**: [Bun](https://bun.sh) 1.2.22+ is required for scripts, tests and the development server.
- **Framework**: Next.js 15 with React 19 renders the dashboards under `src/app`.
- **Styling**: Tailwind CSS 4 with [shadcn/ui](https://ui.shadcn.com) components.
- **Charts**: Recharts is used for the interactive visualisations.
- **Type checking & linting**: TypeScript 5.9 with Biome for lint/format.

The `src/lib` folder houses the data-processing utilities and is heavily unit-tested. Key modules include:

| Module | Responsibility |
| --- | --- |
| `analytics.ts` | Compresses raw session JSON, encrypts sensitive payloads and decrypts them when loading the dashboard. |
| `autoBlock.ts` | Normalises reported addresses/keywords, encrypts legacy user identifiers and emits summary/leaderboard data. |
| `bb10.ts` / `blackberry.ts` | Convert verbose BlackBerry telemetry into compact artefacts while deduplicating and redacting PII. |
| `collectionStats.ts` | Produces time-series metrics for memorisation collections and keeps existing datasets in sync. |
| `csv.ts` | Turns CSV uploads into typed rows with inferred column metadata. |
| `compression.ts` | Shared Brotli helpers for strings, JSON and CSV with base64url utilities. |
| `security.ts` | AES-256-GCM encryption built on HKDF-derived keys. |
| `pii.ts` | Email/phone-number detection filters used during redaction. |
| `utils.ts` | Date/number helpers and filesystem utilities consumed across the pipelines. |

## Environment variables

Encryption helpers require an `ENCRYPTION_SECRET`. In development you can generate one with:

```bash
bun --print "crypto.randomBytes(32).toString('hex')"
```

Set the variable when running scripts/tests that depend on encryption:

```bash
export ENCRYPTION_SECRET="<hex-or-base64-secret>"
```

The test suite automatically initialises secrets where needed, so ordinary `bun test` runs do not require the variable.

## Local development

```bash
bun install            # install dependencies
bun run dev            # start Next.js with Turbopack on http://localhost:3000
bun run build          # create a production build
bun run start          # serve the production bundle
bun run lint           # biome lint checks
bun run format         # biome auto-format
```

### Data files

The dashboards expect preprocessed data inside `public/data`. Key artefacts:

- `analytics.json.br` – Brotli-compressed session analytics produced by `optimizeAnalytics` in `analytics.ts`.
- `autoblock/address.csv.br` & `autoblock/keywords.csv.br` – Generated by `optimizeAddresses` in `autoBlock.ts`.
- `autoblock/user_to_email.json` – Map between anonymised reporter IDs and encrypted emails.
- `bb10/*.csv.br` – Per-app telemetry exported by `optimizeAnalytics` in `bb10.ts`.
- `blackberry/*.json.br` – Aggregated download statistics from `blackberry.ts`.
- `collections/*.json` – Collection definitions and progress generated by `collectionStats.ts`.
- `stats.csv` – Raw CSV uploads read by `csv.ts` when powering ad-hoc statistics.

Each optimiser writes into the current working directory. Running them from the project root will place outputs in `public/data`.

### Running the pipelines

All optimisers are plain async functions. You can execute them via `bun --eval` or a dedicated script. Example:

```bash
bun --eval "import { optimizeAddresses } from './src/lib/autoBlock.ts'; await optimizeAddresses('source/address.csv', 'source/keywords.csv');"
```

Similar invocations exist for:

- `optimizeAnalytics('raw-analytics.json')` in `src/lib/analytics.ts`.
- `optimizeAnalytics('bb10.csv')` in `src/lib/bb10.ts`.
- `loadAutoBlockStats()` / `loadAnalytics()` for consuming the generated artefacts inside API routes or ad-hoc scripts.

## Testing & quality

- Run the full unit-test suite with coverage:

  ```bash
  bun test --coverage
  ```

  This repository currently achieves **100% line coverage** across all library modules.

- Generate an LCOV report (for CI or Codecov uploads):

  ```bash
  bun test --coverage --coverage-reporter=lcov
  ```

- Formatting and linting are handled by Biome (`bun run lint`, `bun run format`).

## Project layout

```
src/
├── app/                # Next.js routes and pages for analytics, BB10, auto-block and collection dashboards
├── components/         # UI primitives (shadcn/ui) and chart wrappers
├── lib/                # Data processing, compression, encryption and tests
└── styles/             # Global Tailwind styles
public/
└── data/               # Pre-computed artefacts served by the app
```

## Contributing

1. Install Bun ≥ 1.2.22.
2. Install dependencies with `bun install`.
3. Keep tests passing (`bun test --coverage`) and lint clean (`bun run lint`).
4. Ensure any new data pipeline functions include thorough JSDoc and accompanying tests to maintain full coverage.

MIT licensed – see [LICENSE.MD](./LICENSE.MD).
